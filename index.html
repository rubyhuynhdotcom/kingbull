  <!-- App Script: SPA + Renderers -->
  <script>
  // --------- Navbar / Tabs ----------
  const navList = $("#navList");
  const navSelect = $("#navSelect");
  function buildNav(){
    TABS.forEach(t=>{
      const btn = document.createElement("button");
      btn.className="nav-btn"; btn.textContent=t.label; btn.dataset.tab=t.key;
      btn.addEventListener("click", ()=>activateTab(t.key,true));
      navList.appendChild(btn);

      const opt=document.createElement("option"); opt.value=t.key; opt.textContent=t.label;
      navSelect.appendChild(opt);
    });
    navSelect.addEventListener("change", e=>activateTab(e.target.value,true));
  }

  function activateTab(key, scroll=false){
    $$(".nav-btn").forEach(b=>{
      b.setAttribute("aria-current", b.dataset.tab===key ? "page" : "false");
    });
    navSelect.value = key;
    TABS.forEach(t=>{
      const el = $("#"+t.key);
      if(!el) return;
      el.style.display = t.key===key ? "" : "none";
    });
    history.replaceState(null,"","#"+key);
    if(scroll){ window.scrollTo({top:0, behavior:"smooth"}); }
    if(key==="map"){ initMapOnce(); }
  }

  // --------- Case Studies ----------
  function renderCaseStudies(){
    const speciesList = ["Tất cả", ...new Set(CASE_STUDIES.map(c=>c.species))];
    const sel = $("#caseFilter");
    speciesList.forEach(s=>{ const o=document.createElement("option"); o.textContent=s; sel.appendChild(o); });
    sel.addEventListener("change",()=>drawCards());
    drawCards();

    function drawCards(){
      const f = sel.value || "Tất cả";
      const data = CASE_STUDIES.filter(x=> f==="Tất cả" || x.species===f);
      const wrap = $("#caseList"); wrap.innerHTML="";
      data.forEach(item=>{
        const revenue = item.harvestTons*1000*item.pricePerKg;
        const feedCost = item.harvestTons*1000*item.fcr*item.feedCostPerKg;
        const net = revenue - feedCost; const roi = net/feedCost*100;
        const card = document.createElement("div"); card.className="card pad fade";
        card.innerHTML = `
          <img class="thumb" src="${item.images[0]}" alt="Ao nuôi - ${item.name}">
          <div class="k-m"><b>${item.name}</b> <span class="pill">${item.species}</span></div>
          <div class="k-m hint">Diện tích: <b>${item.areaHa} ha</b> • Chu kỳ: <b>${item.cycleDays} ngày</b> • Sản lượng: <b>${item.harvestTons} tấn</b> • FCR: <b>${item.fcr}</b></div>
          <div class="row col-3 k-m">
            <div class="card pad"><small>Doanh thu</small><div><b>${fmtVND(revenue)}</b></div></div>
            <div class="card pad"><small>Chi phí thức ăn</small><div><b>${fmtVND(feedCost)}</b></div></div>
            <div class="card pad"><small>ROI</small><div><b>${roi.toFixed(1)}%</b></div></div>
          </div>
          <div class="k-m"><button class="btn primary" data-open="${item.id}">Xem chi tiết</button></div>
        `;
        wrap.appendChild(card);
      });
      wrap.querySelectorAll("[data-open]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const item = CASE_STUDIES.find(c=>c.id==btn.dataset.open);
          openCaseModal(item);
        });
      });
    }
  }

  // --------- Modal (PATCHED) ----------
  function openCaseModal(item){
    $("#mdTitle").textContent = item.name;
    $("#mdSub").textContent = `${item.species} • ${item.started} → ${item.finished}`;
    const revenue = item.harvestTons*1000*item.pricePerKg;
    const feedCost = item.harvestTons*1000*item.fcr*item.feedCostPerKg;
    const net = revenue - feedCost; const roi = net/feedCost*100;
    $("#mdBody").innerHTML = `
      <div class="md-grid">
        <div>
          <iframe title="Video - ${item.name}" class="thumb" style="border-radius:0"
            src="${item.video}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
        <div class="pad">
          <div class="hint">${item.ownerNote}</div>
          <div class="row col-2 k-m">
            <div class="card pad"><small>Doanh thu</small><div><b>${fmtVND(revenue)}</b></div></div>
            <div class="card pad"><small>Chi phí thức ăn</small><div><b>${fmtVND(feedCost)}</b></div></div>
            <div class="card pad"><small>Lợi nhuận (ước)</small><div><b>${fmtVND(net)}</b></div></div>
            <div class="card pad"><small>ROI</small><div><b>${roi.toFixed(1)}%</b></div></div>
          </div>
          <div class="k-m">
            <b>Ghi chú kỹ thuật</b>
            <ul class="list k-m">
              <li>Quản trị oxy hòa tan > 5 mg/L, cho ăn theo đường cong tăng trưởng.</li>
              <li>Tối ưu FCR theo cỡ cá, bổ sung enzymes & probiotics khi chuyển cỡ.</li>
              <li>Theo dõi NH₃/NH₄⁺, NO₂⁻; độ kiềm 80–120 mg/L.</li>
            </ul>
          </div>
        </div>
      </div>
    `;
    $("#modal").hidden=false; $("#modal").classList.add("active"); $("#mdClose").focus();
  }
  $("#mdClose").addEventListener("click", ()=> { $("#modal").classList.remove("active"); $("#modal").hidden=true; });
  $("#modal").addEventListener("click", (e)=>{ if(e.target.id==="modal"){ $("#modal").classList.remove("active"); $("#modal").hidden=true; }});
  document.addEventListener("keydown", e=>{ if(e.key==="Escape"){ $("#modal").classList.remove("active"); $("#modal").hidden=true; }});

  // --------- PDF Library ----------
  function renderPDF(){
    const species = ["Tất cả", ...new Set(PDF_LIBRARY.map(x=>x.species))];
    const stages  = ["Tất cả", ...new Set(PDF_LIBRARY.map(x=>x.stage))];
    const goals   = ["Tất cả", ...new Set(PDF_LIBRARY.map(x=>x.goal))];
    const sp=$("#pdfSpecies"), st=$("#pdfStage"), go=$("#pdfGoal");
    species.forEach(v=>sp.append(new Option(v,v))); stages.forEach(v=>st.append(new Option(v,v))); goals.forEach(v=>go.append(new Option(v,v)));
    sp.addEventListener("change",draw); st.addEventListener("change",draw); go.addEventListener("change",draw);
    draw();
    function draw(){
      const f1=sp.value||"Tất cả", f2=st.value||"Tất cả", f3=go.value||"Tất cả";
      const data = PDF_LIBRARY.filter(x=>
        (f1==="Tất cả"||x.species===f1) && (f2==="Tất cả"||x.stage===f2) && (f3==="Tất cả"||x.goal===f3)
      );
      const wrap=$("#pdfList"); wrap.innerHTML="";
      data.forEach(x=>{
        const d=document.createElement("div"); d.className="card pad fade";
        d.innerHTML=`<b>${x.title}</b>
        <div class="k-m" style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="pill">${x.species}</span><span class="pill">${x.stage}</span><span class="pill">${x.goal}</span>
        </div>
        <div class="k-m"><a class="btn primary" href="${x.url}" target="_blank" download>Tải PDF</a></div>`;
        wrap.appendChild(d);
      });
    }
  }

  // --------- Video ----------
  function renderVideos(){
    const wrap=$("#videoList"); wrap.innerHTML="";
    VIDEO_GALLERY.forEach(v=>{
      const c=document.createElement("div"); c.className="card pad fade";
      c.innerHTML = `
        <iframe title="${v.title}" class="thumb" src="${v.src}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        <div class="k-m"><b>${v.title}</b></div>`;
      wrap.appendChild(c);
    });
  }

  // --------- Dealer Portal (mock) ----------
  function renderDealer(){
    const box=$("#dealerBox"); box.innerHTML="";
    const state = { logged:false };
    draw();

    function draw(){
      box.innerHTML="";
      if(!state.logged){
        const f=document.createElement("form"); f.className="card pad"; f.innerHTML = `
          <b>Đăng nhập</b>
          <label class="k-m"><span>Email</span><input type="email" id="dlEmail" required placeholder="you@company.com" /></label>
          <label class="k-m"><span>Mã truy cập</span><input type="password" id="dlCode" required placeholder="KINGBULL2025" /></label>
          <div id="dlMsg" class="hint k-m" role="status"></div>
          <div class="k-m"><button class="btn primary" type="submit">Đăng nhập</button></div>`;
        f.addEventListener("submit",e=>{
          e.preventDefault();
          const ok = $("#dlCode").value.trim().toUpperCase()==="KINGBULL2025" && $("#dlEmail").value.includes("@");
          if(ok){ state.logged=true; draw(); } else { $("#dlMsg").textContent="Mã truy cập hoặc email không hợp lệ."; }
        });
        box.appendChild(f);
      } else {
        const g=document.createElement("div"); g.className="row col-2";
        g.innerHTML = `
          <div class="card pad">
            <b>Tài liệu nội bộ</b>
            <ul class="list k-m">
              <li><a href="https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf" target="_blank">Bảng giá số lượng lớn (PDF)</a></li>
              <li><a href="https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf" target="_blank">Chính sách chiết khấu (PDF)</a></li>
              <li><a href="https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf" target="_blank">Tài liệu huấn luyện kỹ thuật (PDF)</a></li>
            </ul>
          </div>
          <div class="card pad">
            <b>Video Training</b>
            <ul class="list k-m">
              <li><a href="https://www.youtube.com/watch?v=aqz-KE-bpKQ" target="_blank">Quy trình phối trộn & kiểm soát chất lượng</a></li>
              <li><a href="https://www.youtube.com/watch?v=oUFJJNQGwhk" target="_blank">Vận hành kho lạnh & an toàn</a></li>
            </ul>
          </div>`;
        box.appendChild(g);
      }
    }
  }

  // --------- Map (Leaflet) ----------
  let mapInstance=null, layerGroup=null;
  function initMapOnce(){
    if(mapInstance) return;
    mapInstance = L.map('map').setView([10.5,106],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(mapInstance);
    layerGroup = L.layerGroup().addTo(mapInstance);
    drawMap();
    $("#regionFilter").addEventListener("change", drawMap);
  }
  function drawMap(){
    const region = $("#regionFilter").value || "Tất cả";
    layerGroup.clearLayers();
    WAREHOUSES.filter(w => region==="Tất cả" || w.region===region).forEach(w=>{
      const mk = L.marker([w.lat,w.lng]).addTo(layerGroup); mk.bindPopup(`<b>${w.name}</b><br/>Khu vực: ${w.region}`);
    });
    DESTINATIONS.filter(d => region==="Tất cả" || d.region===region).forEach(d=>{
      const mk = L.circleMarker([d.lat,d.lng],{radius:8,color:"#0EA4E8"}).addTo(layerGroup); mk.bindPopup(`<b>${d.name}</b><br/>Khu vực: ${d.region}`);
    });
  }

  // --------- Support ----------
  $("#supportForm").addEventListener("submit", e=>{
    e.preventDefault();
    $("#supportMsg").textContent = "Đã nhận yêu cầu! Kỹ thuật viên khu vực sẽ liên hệ sớm.";
  });

  // --------- Logistics ----------
  function renderLogistics(){
    const destSel = $("#destSelect"); DESTINATIONS.forEach(d=>destSel.append(new Option(d.name,d.id)));
    $("#logiForm").addEventListener("submit", e=>{
      e.preventDefault();
      const qty = Math.max(1, Number($("#qtyTon").value||0));
      const dest = DESTINATIONS.find(d=>d.id===destSel.value);
      let best=null, bestD=Infinity;
      WAREHOUSES.forEach(w=>{ const d=distanceKm({lat:w.lat,lng:w.lng},{lat:dest.lat,lng:dest.lng}); if(d<bestD){bestD=d; best=w;} });
      const capacityPerContainerTon = 25;
      const trips = ceil(qty / capacityPerContainerTon);
      const hours = bestD/45 + 2;
      const etaDays = Math.max(1, Math.round(hours/8));
      const R=$("#logiResult"); R.style.display="grid"; R.innerHTML="";
      [
        {label:"Kho xuất phát", value:best.name},
        {label:"Khu vực kho", value:best.region},
        {label:"Khoảng cách (km)", value:Math.round(bestD)},
        {label:"Số chuyến (ước)", value:trips},
        {label:"Thời gian giao (ngày)", value:etaDays},
      ].forEach(s=>{
        const c=document.createElement("div"); c.className="card pad";
        c.innerHTML=`<small>${s.label}</small><div><b>${s.value}</b></div>`;
        R.appendChild(c);
      });
    });
  }

  // --------- News ----------
  function renderNews(){
    const tags = ["Tất cả", ...new Set(NEWS.map(n=>n.tag))];
    const nf = $("#newsFilter"); tags.forEach(t=>nf.append(new Option(t,t)));
    nf.addEventListener("change", draw); draw();
    function draw(){
      const f = nf.value || "Tất cả";
      const data = NEWS.filter(n=> f==="Tất cả" || n.tag===f);
      const wrap=$("#newsList"); wrap.innerHTML="";
      data.forEach(n=>{
        const c=document.createElement("div"); c.className="card pad fade";
        c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
          <span class="pill">${n.tag}</span><span class="hint">${n.date}</span></div>
          <div class="k-m"><b>${n.title}</b></div>
          <div class="hint">${n.excerpt}</div>`;
        wrap.appendChild(c);
      });
    }
  }

  // --------- RD ----------
  $("#rdForm").addEventListener("submit", e=>{
    e.preventDefault();
    $("#rdMsg").textContent = "Đã nhận thông tin! Chúng tôi sẽ phản hồi qua email.";
  });

  // --------- Init ----------
  function init(){
    buildNav();
    renderCaseStudies();
    renderPDF();
    renderVideos();
    renderDealer();
    renderLogistics();
    renderNews();
    const start = location.hash?.replace("#","") || "home";
    activateTab(TABS.some(t=>t.key===start)?start:"home");
    $$("[data-goto]").forEach(b=>b.addEventListener("click",()=>activateTab(b.dataset.goto,true)));
    $("#year").textContent = new Date().getFullYear();
  }
  document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
